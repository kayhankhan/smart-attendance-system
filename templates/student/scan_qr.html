{% extends "base.html" %}

{% block title %}Scan QR Code{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-2 sm:px-0">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4 sm:mb-6">Scan QR Code</h1>
    
    <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
        <div class="mb-4 sm:mb-6">
            <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">Point your camera at the QR code displayed by your teacher to mark your attendance.</p>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
                <p class="text-xs sm:text-sm text-blue-800 break-words">üìç <strong>Location Required:</strong> You must be within 100 meters of the class location.</p>
            </div>
        </div>

        <div id="reader" class="mb-4 sm:mb-6 rounded-lg overflow-hidden border-2 border-gray-300"></div>
        
        <div id="status" class="hidden mb-3 sm:mb-4 p-3 sm:p-4 rounded-lg text-sm sm:text-base"></div>
        
        <div class="text-center text-gray-600 text-xs sm:text-sm">
            <p class="mb-2">Having trouble? Make sure to:</p>
            <ul class="list-disc list-inside mt-2 text-left max-w-md mx-auto space-y-1">
                <li>Allow camera and location permissions</li>
                <li>Be within 100 meters of the class location</li>
                <li>Hold the camera steady over the QR code</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let html5QrCode;
let isProcessing = false;

function showStatus(message, isSuccess) {
    const statusDiv = document.getElementById('status');
    statusDiv.className = isSuccess ? 
        'mb-3 sm:mb-4 p-3 sm:p-4 rounded-lg bg-green-100 text-green-800 border border-green-300 text-sm sm:text-base' : 
        'mb-3 sm:mb-4 p-3 sm:p-4 rounded-lg bg-red-100 text-red-800 border border-red-300 text-sm sm:text-base';
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden');
}

async function requestPermissions() {
    try {
        if (navigator.permissions) {
            const cameraPermission = await navigator.permissions.query({ name: 'camera' });
            const locationPermission = await navigator.permissions.query({ name: 'geolocation' });
            
            if (cameraPermission.state === 'denied' || locationPermission.state === 'denied') {
                showStatus('Please enable camera and location permissions in your browser settings', false);
                return false;
            }
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        stream.getTracks().forEach(track => track.stop());
        
        return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
                () => resolve(true),
                (error) => {
                    if (error.code === error.PERMISSION_DENIED) {
                        showStatus('Location permission denied. Please allow location access.', false);
                        resolve(false);
                    } else {
                        resolve(true);
                    }
                },
                { timeout: 5000 }
            );
        });
    } catch (err) {
        showStatus('Camera permission denied. Please allow camera access.', false);
        return false;
    }
}

function onScanSuccess(decodedText, decodedResult) {
    if (isProcessing) return;
    isProcessing = true;
    
    html5QrCode.pause();
    showStatus('QR Code detected! Getting your location...', true);
    
    if (!navigator.geolocation) {
        showStatus('Geolocation is not supported by your browser', false);
        isProcessing = false;
        html5QrCode.resume();
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            
            showStatus('Location obtained! Marking attendance...', true);
            
            fetch('{{ url_for("student.mark_attendance") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: decodedText,
                    latitude: latitude,
                    longitude: longitude
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('‚úì ' + data.message, true);
                    setTimeout(() => {
                        window.location.href = '{{ url_for("student.dashboard") }}';
                    }, 2000);
                } else {
                    showStatus('‚úó ' + data.message, false);
                    setTimeout(() => {
                        isProcessing = false;
                        html5QrCode.resume();
                    }, 3000);
                }
            })
            .catch(error => {
                showStatus('Error: ' + error.message, false);
                setTimeout(() => {
                    isProcessing = false;
                    html5QrCode.resume();
                }, 3000);
            });
        },
        function(error) {
            let errorMessage = 'Error getting location: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Please allow location access';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location unavailable';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Request timeout';
                    break;
                default:
                    errorMessage += error.message;
            }
            showStatus(errorMessage, false);
            isProcessing = false;
            html5QrCode.resume();
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

async function initScanner() {
    const permissionsGranted = await requestPermissions();
    if (!permissionsGranted) {
        return;
    }
    
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        },
        onScanSuccess
    ).catch(err => {
        showStatus('Unable to start camera: ' + err, false);
    });
}

initScanner();
</script>
{% endblock %}
