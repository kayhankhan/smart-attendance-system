{% extends "base.html" %}

{% block title %}Session - {{ session.subject.name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-2 sm:px-0">
    <div class="mb-4 sm:mb-6">
        <a href="{{ url_for('teacher.dashboard') }}" class="text-indigo-600 hover:text-indigo-700 text-sm sm:text-base">&larr; Back to Dashboard</a>
    </div>

    <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-3 sm:mb-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 break-words">{{ session.subject.name }}</h1>
            {% if session.is_past() %}
            <button onclick="calculateDuration()" id="calcDurationBtn"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold whitespace-nowrap self-start">
                ðŸ“Š Calculate Duration
            </button>
            {% endif %}
        </div>
        
        {% if session.is_compensation %}
        <div class="mb-3 sm:mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm font-semibold text-yellow-800">
                ðŸ”„ Compensation Session
                {% if session.compensated_session %}
                - Makes up for {{ session.compensated_session.start_time.strftime('%B %d, %Y') }}
                {% endif %}
            </p>
        </div>
        {% endif %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 text-gray-700">
            <div class="space-y-2">
                <p class="text-sm sm:text-base"><strong>Subject Code:</strong> {{ session.subject.code }}</p>
                <p class="text-sm sm:text-base break-words"><strong>Start:</strong> {{ session.start_time.strftime('%A, %B %d, %Y at %I:%M %p') }}</p>
                <p class="text-sm sm:text-base"><strong>End:</strong> {{ session.end_time.strftime('%I:%M %p') }}</p>
            </div>
            <div class="space-y-2">
                {% if session.location_name %}
                <p class="text-sm sm:text-base break-words"><strong>Location:</strong> {{ session.location_name }}</p>
                {% endif %}
                <p class="text-sm sm:text-base break-all"><strong>Coordinates:</strong> {{ "%.6f"|format(session.location_lat) }}, {{ "%.6f"|format(session.location_lng) }}</p>
                <p class="text-sm sm:text-base"><strong>Verified Attendance:</strong> {{ verified_count }}/{{ attendance_records|length }}</p>
            </div>
        </div>
        {% if session.notes %}
        <div class="mt-3 sm:mt-4 p-3 sm:p-4 bg-gray-50 rounded">
            <p class="text-xs sm:text-sm text-gray-700 break-words"><strong>Notes:</strong> {{ session.notes }}</p>
        </div>
        {% endif %}
        <div id="durationStatus" class="mt-3 hidden"></div>
    </div>

    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg shadow p-4 sm:p-6 md:p-8 mb-4 sm:mb-6 text-center">
        <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4">QR Code for Attendance</h2>
        <p class="mb-3 sm:mb-4 text-sm sm:text-base">Display this QR code for students to scan</p>
        <div class="bg-white p-4 sm:p-6 rounded-lg inline-block">
            <img id="qrCodeImage" 
                 src="{{ url_for('static', filename='qr_codes/session_' + session.id|string + '.png') }}?t={{ session.qr_token[:8] }}" 
                 alt="QR Code" 
                 class="max-w-xs mx-auto w-full"
                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\' viewBox=\'0 0 200 200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'100\' y=\'95\' font-family=\'Arial\' font-size=\'14\' fill=\'%23dc2626\' text-anchor=\'middle\'%3EQRCODE ERROR%3C/text%3E%3Ctext x=\'100\' y=\'115\' font-family=\'Arial\' font-size=\'12\' fill=\'%23666\' text-anchor=\'middle\'%3EClick refresh below%3C/text%3E%3C/svg%3E'; document.getElementById('qrErrorMsg').classList.remove('hidden');">
        </div>
        <p id="qrErrorMsg" class="mt-3 text-sm bg-red-100 text-red-800 p-2 rounded hidden">
            QR code failed to load. Click "Refresh QR Code" button below to regenerate it.
        </p>
        <p class="mt-3 sm:mt-4 text-xs sm:text-sm opacity-90">Students must be within 100 meters to mark attendance</p>
        <p class="mt-2 text-xs sm:text-sm opacity-75">
            QR code refreshes in <span id="countdown" class="font-bold">20</span> seconds
        </p>
        <button onclick="refreshQRCode(); countdown = 20;" 
                class="mt-3 bg-white text-indigo-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors text-sm font-semibold">
            ðŸ”„ Refresh QR Code
        </button>
        <p id="refreshStatus" class="mt-2 text-xs sm:text-sm font-semibold hidden"></p>
    </div>

    <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-6">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-4 mb-3 sm:mb-4">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Attendance Records</h2>
            <a href="{{ url_for('teacher.export_csv', session_id=session.id) }}" 
               class="bg-green-600 text-white px-3 sm:px-4 py-2 rounded hover:bg-green-700 text-xs sm:text-sm text-center whitespace-nowrap">
                ðŸ“¥ Export CSV
            </a>
        </div>

        {% if attendance_records %}
        <div class="overflow-x-auto -mx-3 sm:-mx-4 md:-mx-6 px-3 sm:px-4 md:px-6">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Distance</th>
                        <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Time</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for record in attendance_records %}
                    <tr>
                        <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4">
                            <div class="font-medium text-gray-900 text-xs sm:text-sm break-words">{{ record.student.full_name }}</div>
                            <div class="text-xs text-gray-500">{{ record.student.student_id }}</div>
                        </td>
                        <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4">
                            {% if record.verification_status == 'VERIFIED' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Verified
                                {% if record.duration_percentage %}
                                ({{ "%.0f"|format(record.duration_percentage) }}%)
                                {% endif %}
                            </span>
                            {% elif record.verification_status == 'REJECTED_DURATION' %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                                Duration {% if record.duration_percentage %}{{ "%.0f"|format(record.duration_percentage) }}%{% endif %}
                            </span>
                            {% else %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                {{ record.verification_status }}
                            </span>
                            {% endif %}
                            <div class="text-xs text-gray-500 sm:hidden mt-1">
                                {{ "%.1f"|format(record.distance_meters) }}m â€¢ {{ record.timestamp.strftime('%I:%M %p') }}
                            </div>
                        </td>
                        <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 text-xs sm:text-sm text-gray-500 hidden sm:table-cell">
                            {{ "%.1f"|format(record.distance_meters) }}m
                        </td>
                        <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 text-xs sm:text-sm text-gray-500 hidden md:table-cell">
                            {{ record.timestamp.strftime('%I:%M %p') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 text-center py-6 sm:py-8 text-sm sm:text-base">No attendance records yet</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const QR_REFRESH_INTERVAL = 20;
    let countdown = QR_REFRESH_INTERVAL;
    const sessionId = {{ session.id }};
    const countdownElement = document.getElementById('countdown');
    const qrCodeImage = document.getElementById('qrCodeImage');
    const refreshStatus = document.getElementById('refreshStatus');
    
    function calculateDuration() {
        const btn = document.getElementById('calcDurationBtn');
        const statusDiv = document.getElementById('durationStatus');
        
        btn.disabled = true;
        btn.textContent = 'Calculating...';
        
        fetch(`/teacher/sessions/${sessionId}/calculate_duration`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded-lg';
                statusDiv.innerHTML = `<p class="text-sm text-green-800"><strong>âœ“ Success:</strong> ${data.message}</p>`;
                statusDiv.classList.remove('hidden');
                setTimeout(() => location.reload(), 2000);
            } else {
                statusDiv.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded-lg';
                statusDiv.innerHTML = `<p class="text-sm text-red-800"><strong>âœ— Error:</strong> ${data.message}</p>`;
                statusDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'ðŸ“Š Calculate Duration';
            }
        })
        .catch(error => {
            statusDiv.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded-lg';
            statusDiv.innerHTML = `<p class="text-sm text-red-800"><strong>âœ— Error:</strong> ${error.message}</p>`;
            statusDiv.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = 'ðŸ“Š Calculate Duration';
        });
    }
    
    function showStatus(message, isError = false) {
        refreshStatus.textContent = message;
        refreshStatus.className = isError 
            ? 'mt-2 text-sm font-semibold text-red-200' 
            : 'mt-2 text-sm font-semibold text-green-200';
        refreshStatus.classList.remove('hidden');
        
        setTimeout(() => {
            refreshStatus.classList.add('hidden');
        }, 3000);
    }
    
    function refreshQRCode() {
        fetch(`/teacher/sessions/${sessionId}/refresh_qr`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to refresh QR code');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    qrCodeImage.src = data.qr_url + '?t=' + new Date().getTime();
                    showStatus('QR code refreshed successfully');
                } else {
                    showStatus('Failed to refresh QR code. Please reload the page.', true);
                    console.warn('QR refresh unsuccessful:', data.error);
                }
            })
            .catch(error => {
                showStatus('Network error refreshing QR code. Retrying in ' + QR_REFRESH_INTERVAL + ' seconds...', true);
                console.error('Error refreshing QR code:', error);
            });
    }
    
    function updateCountdown() {
        countdown--;
        
        if (countdown <= 0) {
            countdown = QR_REFRESH_INTERVAL;
            countdownElement.textContent = countdown;
            refreshQRCode();
        } else {
            countdownElement.textContent = countdown;
        }
    }
    
    setInterval(updateCountdown, 1000);
</script>
{% endblock %}
